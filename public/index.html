<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuestMirror ‚Äî Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#07080f;--bg2:#0d0f1a;--bg3:#131625;--border:#1e2238;--border2:#2a2f50;
      --accent:#5b6ef5;--accent2:#7c8fff;--green:#2dff8f;--red:#ff4466;--yellow:#ffcc44;
      --text:#e8eaf6;--text2:#7a82aa;--text3:#3d4266;
      --mono:'Space Mono',monospace;--sans:'Syne',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
    body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:0.4;}

    /* LOGIN */
    #login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;background:var(--bg);}
    .login-card{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:48px 40px;width:100%;max-width:420px;text-align:center;position:relative;overflow:hidden;}
    .login-card::before{content:'';position:absolute;top:-60px;left:50%;transform:translateX(-50%);width:200px;height:200px;background:radial-gradient(circle,rgba(91,110,245,0.15) 0%,transparent 70%);pointer-events:none;}
    .login-logo{font-size:2rem;font-weight:800;letter-spacing:-1px;margin-bottom:6px;}
    .login-logo span{color:var(--accent2);}
    .login-sub{font-size:0.8rem;color:var(--text2);font-family:var(--mono);margin-bottom:36px;letter-spacing:2px;text-transform:uppercase;}
    .lf{margin-bottom:16px;text-align:left;}
    .lf label{display:block;font-size:0.75rem;color:var(--text2);font-family:var(--mono);margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;}
    .lf input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;color:var(--text);font-family:var(--mono);font-size:0.95rem;outline:none;transition:border-color 0.2s;}
    .lf input:focus{border-color:var(--accent);}
    .btn-primary{width:100%;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:13px;font-family:var(--sans);font-size:1rem;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:8px;}
    .btn-primary:hover{background:var(--accent2);transform:translateY(-1px);}
    .btn-primary:disabled{background:var(--bg3);color:var(--text3);cursor:default;transform:none;}
    .login-error{color:var(--red);font-size:0.82rem;font-family:var(--mono);margin-top:12px;display:none;}

    /* APP */
    #app{display:none;min-height:100vh;position:relative;z-index:1;}

    /* TOPBAR */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:64px;border-bottom:1px solid var(--border);background:rgba(7,8,15,0.8);backdrop-filter:blur(12px);position:sticky;top:0;z-index:50;}
    .topbar-logo{font-size:1.1rem;font-weight:800;letter-spacing:-0.5px;}
    .topbar-logo span{color:var(--accent2);}
    .topbar-right{display:flex;align-items:center;gap:20px;}
    .topbar-badge{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-family:var(--mono);font-size:0.78rem;color:var(--text2);}
    .live-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse-dot 2s infinite;}
    @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
    .btn-logout{background:none;border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--text2);font-family:var(--mono);font-size:0.78rem;cursor:pointer;transition:all 0.2s;}
    .btn-logout:hover{border-color:var(--red);color:var(--red);}

    /* MAIN */
    .main{padding:40px 32px;max-width:1200px;margin:0 auto;}
    .page-title{font-size:2rem;font-weight:800;letter-spacing:-1px;margin-bottom:40px;}
    .page-title small{display:block;font-size:0.8rem;font-weight:400;color:var(--text2);font-family:var(--mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}

    /* STATS */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:40px;}
    .stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px 24px;position:relative;overflow:hidden;}
    .stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
    .stat-label{font-size:0.72rem;color:var(--text2);font-family:var(--mono);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;}
    .stat-value{font-size:2rem;font-weight:800;font-family:var(--mono);}
    .stat-value.green{color:var(--green);}
    .stat-value.accent{color:var(--accent2);}

    /* SECTION */
    .section-title{font-size:0.72rem;font-family:var(--mono);color:var(--text3);letter-spacing:3px;text-transform:uppercase;margin-bottom:20px;display:flex;align-items:center;gap:12px;}
    .section-title::after{content:'';flex:1;height:1px;background:var(--border);}

    /* CREATE CARD */
    .create-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;margin-bottom:40px;}
    .create-grid{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:16px;align-items:end;}
    @media(max-width:900px){.create-grid{grid-template-columns:1fr 1fr;}}
    .field label{display:block;font-size:0.72rem;color:var(--text2);font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;}
    .field input,.field select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text);font-family:var(--mono);font-size:0.9rem;outline:none;transition:border-color 0.2s;}
    .field input:focus,.field select:focus{border-color:var(--accent);}
    .field select option{background:var(--bg3);}
    .btn-create{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:11px 24px;font-family:var(--sans);font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap;height:44px;}
    .btn-create:hover{background:var(--accent2);transform:translateY(-1px);}
    .btn-create:disabled{background:var(--bg3);color:var(--text3);cursor:default;transform:none;}

    /* SERVER GRID */
    .servers-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:20px;}
    .server-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:border-color 0.2s,transform 0.2s;animation:fadeIn 0.3s ease;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .server-card:hover{border-color:var(--border2);transform:translateY(-2px);}
    .server-card.active-card{border-color:rgba(91,110,245,0.4);}

    .card-header{padding:20px 22px 16px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .card-name{font-size:1.05rem;font-weight:700;margin-bottom:4px;}
    .card-id{font-family:var(--mono);font-size:1.4rem;font-weight:700;color:var(--accent2);letter-spacing:4px;display:flex;align-items:center;gap:8px;}
    .copy-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.85rem;padding:2px 6px;border-radius:4px;transition:color 0.2s;}
    .copy-btn:hover{color:var(--accent2);}
    .card-status{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:0.72rem;padding:4px 10px;border-radius:20px;white-space:nowrap;border:1px solid transparent;}
    .card-status.online{background:rgba(45,255,143,0.1);border-color:rgba(45,255,143,0.2);color:var(--green);}
    .card-status.offline{background:rgba(122,130,170,0.1);border-color:var(--border);color:var(--text2);}
    .status-dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
    .status-dot.pulse{animation:pulse-dot 1.5s infinite;}

    .card-body{padding:16px 22px;}

    /* Senders */
    .senders-title{font-size:0.68rem;font-family:var(--mono);color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:10px;}
    .senders-list{display:flex;flex-direction:column;gap:6px;min-height:40px;}
    .sender-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:0.82rem;transition:all 0.2s;}
    .sender-row.connected{border-color:rgba(45,255,143,0.2);}
    .sender-row.is-active{border-color:var(--accent);background:rgba(91,110,245,0.08);}
    .sender-name-wrap{display:flex;align-items:center;gap:8px;font-family:var(--mono);color:var(--text);}
    .sender-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);flex-shrink:0;}
    .sender-dot.on{background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse-dot 2s infinite;}
    .sender-dot.active-dot{background:var(--accent2);box-shadow:0 0 6px var(--accent2);}
    .sender-actions{display:flex;align-items:center;gap:6px;}
    .sender-since{font-size:0.68rem;color:var(--text3);font-family:var(--mono);}
    .btn-activate{font-size:0.65rem;font-family:var(--mono);background:rgba(91,110,245,0.15);border:1px solid rgba(91,110,245,0.3);color:var(--accent2);border-radius:5px;padding:3px 8px;cursor:pointer;transition:all 0.15s;white-space:nowrap;}
    .btn-activate:hover{background:rgba(91,110,245,0.3);}
    .btn-activate.is-current{background:var(--accent);color:#fff;border-color:var(--accent);}
    .no-senders{color:var(--text3);font-size:0.8rem;font-family:var(--mono);text-align:center;padding:8px 0;}

    /* Inline edit */
    .card-meta{display:flex;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);flex-wrap:wrap;align-items:center;}
    .meta-chip{font-size:0.7rem;font-family:var(--mono);color:var(--text2);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 10px;}
    .meta-edit{display:flex;align-items:center;gap:6px;font-size:0.7rem;font-family:var(--mono);color:var(--text2);}
    .meta-edit select{background:var(--bg3);border:1px solid var(--border2);border-radius:6px;padding:3px 8px;color:var(--accent2);font-family:var(--mono);font-size:0.7rem;outline:none;cursor:pointer;}
    .meta-edit select:focus{border-color:var(--accent);}

    /* Card footer */
    .card-footer{padding:12px 22px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .btn-sm{font-size:0.75rem;font-family:var(--mono);border-radius:7px;padding:6px 12px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text2);transition:all 0.15s;}
    .btn-sm:hover{color:var(--text);border-color:var(--border2);}
    .btn-sm.danger:hover{color:var(--red);border-color:rgba(255,68,102,0.4);}
    .btn-sm.accent-btn{color:var(--accent2);border-color:rgba(91,110,245,0.3);}
    .btn-sm.accent-btn:hover{background:rgba(91,110,245,0.1);}

    /* Empty / Loading */
    .empty-state{text-align:center;padding:80px 20px;color:var(--text3);grid-column:1/-1;}
    .empty-icon{font-size:3rem;margin-bottom:16px;opacity:0.5;}
    .empty-title{font-size:1rem;font-weight:700;color:var(--text2);margin-bottom:6px;}
    .empty-sub{font-size:0.82rem;font-family:var(--mono);}
    .loading{display:flex;align-items:center;justify-content:center;padding:60px;grid-column:1/-1;}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Toast */
    #toast{position:fixed;bottom:32px;right:32px;z-index:200;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:14px 20px;font-family:var(--mono);font-size:0.82rem;color:var(--text);transform:translateY(80px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 8px 32px rgba(0,0,0,0.4);}
    #toast.show{transform:translateY(0);opacity:1;}
    #toast.success{border-color:rgba(45,255,143,0.3);}
    #toast.error{border-color:rgba(255,68,102,0.3);}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(7,8,15,0.85);backdrop-filter:blur(4px);z-index:150;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.2s;}
    .modal-overlay.open{opacity:1;pointer-events:all;}
    .modal{background:var(--bg2);border:1px solid var(--border2);border-radius:20px;padding:36px;width:100%;max-width:440px;transform:scale(0.95);transition:transform 0.2s;}
    .modal-overlay.open .modal{transform:scale(1);}
    .modal-title{font-size:1.2rem;font-weight:800;margin-bottom:8px;}
    .modal-sub{font-size:0.82rem;color:var(--text2);font-family:var(--mono);margin-bottom:28px;}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:28px;}
    .btn-cancel{background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:10px;padding:10px 20px;cursor:pointer;font-family:var(--sans);font-size:0.9rem;transition:all 0.15s;}
    .btn-cancel:hover{color:var(--text);}
    .btn-confirm-delete{background:rgba(255,68,102,0.15);border:1px solid rgba(255,68,102,0.3);color:var(--red);border-radius:10px;padding:10px 20px;cursor:pointer;font-family:var(--sans);font-size:0.9rem;font-weight:700;transition:all 0.15s;}
    .btn-confirm-delete:hover{background:rgba(255,68,102,0.25);}

    /* Refresh btn */
    #refresh-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:10px;padding:8px 14px;cursor:pointer;transition:all 0.2s;font-size:1.1rem;}
    #refresh-btn:hover{border-color:var(--accent);color:var(--accent2);}
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">Quest<span>Mirror</span></div>
    <div class="login-sub">Admin Panel</div>
    <div class="lf"><label>Email</label><input type="email" id="login-email" placeholder="admin@exemplo.com"/></div>
    <div class="lf"><label>Senha</label><input type="password" id="login-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
    <button class="btn-primary" id="login-btn">Entrar</button>
    <div class="login-error" id="login-error">Email ou senha incorretos.</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <nav class="topbar">
    <div class="topbar-logo">Quest<span>Mirror</span></div>
    <div class="topbar-right">
      <div class="topbar-badge"><span class="live-dot"></span><span id="topbar-count">0 online</span></div>
      <button class="btn-logout" id="logout-btn">Sair</button>
    </div>
  </nav>

  <div class="main">
    <div class="page-title"><small>Painel de Controle</small>QuestMirror</div>

    <!-- STATS -->
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">Total de Servers</div><div class="stat-value accent" id="stat-total">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Servers Ativos</div><div class="stat-value green" id="stat-active">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Quests Conectados</div><div class="stat-value" id="stat-quests">‚Äî</div></div>
      <div class="stat-card"><div class="stat-label">Receivers Online</div><div class="stat-value" id="stat-receivers">‚Äî</div></div>
    </div>

    <!-- CREATE -->
    <div class="section-title">Criar Novo Server</div>
    <div class="create-card">
      <div class="create-grid">
        <div class="field"><label>Nome do Server</label><input type="text" id="new-name" placeholder="ex: Sala A, Evento VR..." maxlength="40"/></div>
        <div class="field">
          <label>Rota√ß√£o (segundos)</label>
          <select id="new-interval">
            <option value="5">5 segundos</option>
            <option value="10" selected>10 segundos</option>
            <option value="15">15 segundos</option>
            <option value="30">30 segundos</option>
            <option value="60">1 minuto</option>
            <option value="0">Manual</option>
          </select>
        </div>
        <div class="field">
          <label>M√°x. Quests (1‚Äì6)</label>
          <select id="new-max">
            <option value="1">1 Quest</option>
            <option value="2">2 Quests</option>
            <option value="3">3 Quests</option>
            <option value="4" selected>4 Quests</option>
            <option value="5">5 Quests</option>
            <option value="6">6 Quests</option>
          </select>
        </div>
        <button class="btn-create" id="create-btn">+ Criar</button>
      </div>
    </div>

    <!-- SERVERS -->
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div class="section-title" style="margin-bottom:0;flex:1">Servers</div>
      <button id="refresh-btn" title="Atualizar">‚Üª</button>
    </div>
    <div class="servers-grid" id="servers-grid">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal">
    <div class="modal-title">Deletar Server?</div>
    <div class="modal-sub" id="delete-modal-sub">Esta a√ß√£o n√£o pode ser desfeita.</div>
    <div class="modal-actions">
      <button class="btn-cancel" id="delete-cancel">Cancelar</button>
      <button class="btn-confirm-delete" id="delete-confirm">Deletar</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, getDocs, deleteDoc,
         updateDoc, onSnapshot, query, orderBy, serverTimestamp, getDoc }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyCEPrlqbW7ec7mSJLJF6lrY6pk-F1EXGTE",
  authDomain:        "questmirror-server.firebaseapp.com",
  projectId:         "questmirror-server",
  storageBucket:     "questmirror-server.firebasestorage.app",
  messagingSenderId: "248196878452",
  appId:             "1:248196878452:web:2c92315ea5e2edca5a0121"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// DOM
const loginScreen  = document.getElementById('login-screen');
const appEl        = document.getElementById('app');
const loginBtn     = document.getElementById('login-btn');
const logoutBtn    = document.getElementById('logout-btn');
const loginEmail   = document.getElementById('login-email');
const loginPass    = document.getElementById('login-pass');
const loginError   = document.getElementById('login-error');
const createBtn    = document.getElementById('create-btn');
const refreshBtn   = document.getElementById('refresh-btn');
const serversGrid  = document.getElementById('servers-grid');
const deleteModal  = document.getElementById('delete-modal');
const deleteSub    = document.getElementById('delete-modal-sub');
const deleteCancel = document.getElementById('delete-cancel');
const deleteConfirm= document.getElementById('delete-confirm');

let serversCache       = [];
let serversUnsubscribe = null;
let pendingDeleteId    = null;
let toastTimer;

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = (type==='success'?'‚úì ':'‚úï ') + msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.className=''; }, 3000);
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, user => {
  if (user) {
    loginScreen.style.display = 'none';
    appEl.style.display = 'block';
    startListening();
  } else {
    loginScreen.style.display = 'flex';
    appEl.style.display = 'none';
    if (serversUnsubscribe) serversUnsubscribe();
  }
});

loginBtn.addEventListener('click', async () => {
  const email = loginEmail.value.trim();
  const pass  = loginPass.value;
  if (!email || !pass) return;
  loginBtn.textContent = 'Entrando...'; loginBtn.disabled = true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    loginError.style.display = 'none';
  } catch(e) {
    loginError.style.display = 'block';
    loginBtn.textContent = 'Entrar'; loginBtn.disabled = false;
  }
});
loginPass.addEventListener('keydown', e => { if(e.key==='Enter') loginBtn.click(); });
logoutBtn.addEventListener('click', () => signOut(auth));

// ‚îÄ‚îÄ GENERATE ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateUniqueId() {
  const existing = new Set(serversCache.map(s => s.serverId));
  let id, attempts = 0;
  do { id = String(Math.floor(100000 + Math.random() * 900000)); attempts++; }
  while (existing.has(id) && attempts < 50);
  return id;
}

// ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
createBtn.addEventListener('click', async () => {
  const name     = document.getElementById('new-name').value.trim();
  const interval = parseInt(document.getElementById('new-interval').value);
  const maxS     = parseInt(document.getElementById('new-max').value);
  if (!name) { toast('Digite um nome para o server', 'error'); return; }
  createBtn.textContent = 'Criando...'; createBtn.disabled = true;
  try {
    const id = await generateUniqueId();
    await addDoc(collection(db, 'servers'), {
      serverId: id, name, rotationInterval: interval,
      maxSenders: maxS, active: true,
      createdAt: serverTimestamp(), currentSender: null
    });
    document.getElementById('new-name').value = '';
    toast(`Server "${name}" criado! ID: ${id}`);
  } catch(e) { toast('Erro: ' + e.message, 'error'); }
  createBtn.textContent = '+ Criar'; createBtn.disabled = false;
});

refreshBtn.addEventListener('click', () => {
  refreshBtn.style.transform = 'rotate(360deg)';
  refreshBtn.style.transition = 'transform 0.5s';
  setTimeout(()=>{ refreshBtn.style.transform=''; refreshBtn.style.transition=''; }, 500);
});

// ‚îÄ‚îÄ REALTIME LISTENER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startListening() {
  const q = query(collection(db, 'servers'), orderBy('createdAt', 'desc'));
  serversUnsubscribe = onSnapshot(q, async snap => {
    serversCache = snap.docs.map(d => ({ docId: d.id, ...d.data() }));
    await renderServers();
  });
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderServers() {
  const servers = serversCache;
  let totalQuests=0, totalReceivers=0, activeServers=0;

  const enriched = await Promise.all(servers.map(async s => {
    try {
      const sendSnap = await getDocs(collection(db, 'servers', s.docId, 'senders'));
      const senders  = sendSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      const connected = senders.filter(x => x.connected);
      totalQuests += connected.length;
      if (connected.length > 0) activeServers++;
      const recvSnap  = await getDocs(collection(db, 'servers', s.docId, 'receivers'));
      totalReceivers += recvSnap.docs.filter(d => d.data().connected).length;
      return { ...s, senders, connectedSenders: connected };
    } catch { return { ...s, senders: [], connectedSenders: [] }; }
  }));

  document.getElementById('stat-total').textContent     = servers.length;
  document.getElementById('stat-active').textContent    = activeServers;
  document.getElementById('stat-quests').textContent    = totalQuests;
  document.getElementById('stat-receivers').textContent = totalReceivers;
  document.getElementById('topbar-count').textContent   = totalQuests + ' online';

  if (servers.length === 0) {
    serversGrid.innerHTML = `<div class="empty-state"><div class="empty-icon">ü•Ω</div><div class="empty-title">Nenhum server criado</div><div class="empty-sub">Crie um server acima para come√ßar</div></div>`;
    return;
  }

  serversGrid.innerHTML = enriched.map(s => renderCard(s)).join('');
  bindCardEvents();
}

function renderCard(s) {
  const isOnline = s.connectedSenders.length > 0;
  const statusCls = isOnline ? 'online' : 'offline';
  const statusLbl = isOnline ? 'Online' : 'Offline';

  const sendersHtml = s.senders.length === 0
    ? `<div class="no-senders">Nenhum Quest conectado</div>`
    : s.senders.map(sender => {
        const on       = sender.connected;
        const isCurrent= s.currentSender === sender.id;
        const since    = sender.lastSeen?.toDate ? timeAgo(sender.lastSeen.toDate()) : '‚Äî';
        return `
          <div class="sender-row ${on?'connected':''} ${isCurrent?'is-active':''}">
            <div class="sender-name-wrap">
              <span class="sender-dot ${on?(isCurrent?'active-dot':'on'):''}"></span>
              ${esc(sender.questName||'Quest')}
              ${isCurrent ? '<span style="font-size:0.62rem;color:var(--accent2);margin-left:4px;">‚óè ATIVO</span>' : ''}
            </div>
            <div class="sender-actions">
              <span class="sender-since">${on?'ao vivo':since}</span>
              ${on ? `<button class="btn-activate ${isCurrent?'is-current':''}"
                data-server="${s.docId}" data-sender="${sender.id}"
                data-current="${isCurrent}">
                ${isCurrent ? '‚úì Exibindo' : 'Exibir'}
              </button>` : ''}
            </div>
          </div>`;
      }).join('');

  const intervalLbl = s.rotationInterval===0 ? 'Manual' : s.rotationInterval+'s';

  return `
    <div class="server-card ${isOnline?'active-card':''}">
      <div class="card-header">
        <div>
          <div class="card-name">${esc(s.name)}</div>
          <div class="card-id">${s.serverId}<button class="copy-btn" data-copy="${s.serverId}">‚éò</button></div>
        </div>
        <div class="card-status ${statusCls}">
          <span class="status-dot ${isOnline?'pulse':''}"></span>${statusLbl}
        </div>
      </div>
      <div class="card-body">
        <div class="senders-title">Quests Conectados (${s.connectedSenders.length}/${s.maxSenders})</div>
        <div class="senders-list">${sendersHtml}</div>
        <div class="card-meta">
          <span class="meta-chip">${s.active?'‚úì ativo':'‚úó inativo'}</span>
          <div class="meta-edit">
            ‚Üª
            <select data-edit-interval="${s.docId}">
              ${[5,10,15,30,60,0].map(v=>`<option value="${v}" ${s.rotationInterval==v?'selected':''}>${v===0?'Manual':v+'s'}</option>`).join('')}
            </select>
          </div>
          <div class="meta-edit">
            Quests
            <select data-edit-max="${s.docId}">
              ${[1,2,3,4,5,6].map(v=>`<option value="${v}" ${s.maxSenders==v?'selected':''}>${v}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <div style="display:flex;gap:8px;">
          <button class="btn-sm accent-btn" data-copy="${s.serverId}">Copiar ID</button>
          <button class="btn-sm" data-toggle="${s.docId}" data-active="${s.active}">${s.active?'Desativar':'Ativar'}</button>
        </div>
        <button class="btn-sm danger" data-delete="${s.docId}" data-name="${esc(s.name)}">Deletar</button>
      </div>
    </div>`;
}

function bindCardEvents() {
  // Copy ID
  serversGrid.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', () => { navigator.clipboard.writeText(btn.dataset.copy); toast('ID copiado: ' + btn.dataset.copy); });
  });

  // Delete
  serversGrid.querySelectorAll('[data-delete]').forEach(btn => {
    btn.addEventListener('click', () => openDeleteModal(btn.dataset.delete, btn.dataset.name));
  });

  // Toggle active
  serversGrid.querySelectorAll('[data-toggle]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const active = btn.dataset.active === 'true';
      await updateDoc(doc(db, 'servers', btn.dataset.toggle), { active: !active });
      toast(active ? 'Server desativado' : 'Server ativado');
    });
  });

  // Set active sender (manual switch)
  serversGrid.querySelectorAll('[data-sender]').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (btn.dataset.current === 'true') return;
      await updateDoc(doc(db, 'servers', btn.dataset.server), { currentSender: btn.dataset.sender });
      toast('Quest trocado!');
    });
  });

  // Edit interval inline
  serversGrid.querySelectorAll('[data-edit-interval]').forEach(sel => {
    sel.addEventListener('change', async () => {
      const val = parseInt(sel.value);
      await updateDoc(doc(db, 'servers', sel.dataset.editInterval), { rotationInterval: val });
      toast('Intervalo atualizado: ' + (val===0?'Manual':val+'s'));
    });
  });

  // Edit max senders inline
  serversGrid.querySelectorAll('[data-edit-max]').forEach(sel => {
    sel.addEventListener('change', async () => {
      const val = parseInt(sel.value);
      await updateDoc(doc(db, 'servers', sel.dataset.editMax), { maxSenders: val });
      toast('M√°x. Quests atualizado: ' + val);
    });
  });
}

// ‚îÄ‚îÄ DELETE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDeleteModal(docId, name) {
  pendingDeleteId = docId;
  deleteSub.textContent = `Deletar "${name}"? Esta a√ß√£o n√£o pode ser desfeita.`;
  deleteModal.classList.add('open');
}
deleteCancel.addEventListener('click', () => { deleteModal.classList.remove('open'); pendingDeleteId=null; });
deleteConfirm.addEventListener('click', async () => {
  if (!pendingDeleteId) return;
  deleteConfirm.textContent = 'Deletando...';
  try { await deleteDoc(doc(db, 'servers', pendingDeleteId)); toast('Server deletado'); }
  catch(e) { toast('Erro ao deletar', 'error'); }
  deleteModal.classList.remove('open'); pendingDeleteId=null; deleteConfirm.textContent='Deletar';
});

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(d) {
  const s = Math.floor((Date.now()-d.getTime())/1000);
  if(s<60) return s+'s atr√°s';
  const m=Math.floor(s/60); if(m<60) return m+'min atr√°s';
  return Math.floor(m/60)+'h atr√°s';
}
</script>
</body>
</html>